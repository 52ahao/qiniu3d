<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI 生成 - 七牛三弟</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <style>body{background:#0b0f1a}</style>
    <script src="js/api.js"></script>
</head>
<body class="text-slate-200">
    <div class="max-w-7xl mx-auto p-4 grid lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 space-y-4">
            <div class="bg-slate-900 border border-slate-800 rounded-xl p-4 space-y-3">
                <h1 class="text-lg font-medium">文本/图像生成 3D</h1>
                <div class="grid md:grid-cols-2 gap-3">
                    <div class="space-y-2">
                        <label class="text-xs text-slate-400">正向提示</label>
                        <textarea id="input-positive" class="w-full h-28 bg-slate-950 border border-slate-800 rounded-lg p-3 text-sm" placeholder="例如：一架未来感无人机，银黑配色，干净硬朗的线条…"></textarea>
                    </div>
                    <div class="space-y-2">
                        <label class="text-xs text-slate-400">反向提示</label>
                        <textarea id="input-negative" class="w-full h-28 bg-slate-950 border border-slate-800 rounded-lg p-3 text-sm" placeholder="排除：低多边形、模糊、错误拓扑…"></textarea>
                    </div>
                </div>

                <div class="grid md:grid-cols-3 gap-3">
                    <div>
                        <label class="text-xs text-slate-400">拓扑</label>
                        <select id="select-topology" class="w-full bg-slate-950 border border-slate-800 rounded-lg p-2 text-sm">
                            <option>四边面优先</option>
                            <option>三角面</option>
                            <option>自动混合</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-slate-400">贴图</label>
                        <select id="select-texture" class="w-full bg-slate-950 border border-slate-800 rounded-lg p-2 text-sm">
                            <option>PBR（金属度/粗糙度）</option>
                            <option>仅颜色贴图</option>
                            <option>无贴图</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-slate-400">分辨率</label>
                        <select id="select-resolution" class="w-full bg-slate-950 border border-slate-800 rounded-lg p-2 text-sm">
                            <option>2K</option>
                            <option>1K</option>
                            <option>4K</option>
                        </select>
                    </div>
                </div>

                <div class="flex items-center gap-3 text-sm">
                    <label class="flex items-center gap-2"><input id="chk-retopo" type="checkbox" class="accent-indigo-600" checked /> 重拓扑</label>
                    <label class="flex items-center gap-2"><input id="chk-bake" type="checkbox" class="accent-indigo-600" checked /> 法线烘焙</label>
                    <label class="flex items-center gap-2"><input id="chk-decimate" type="checkbox" class="accent-indigo-600" /> 减面优化</label>
                </div>

                <div class="flex items-center gap-3">
                    <button id="btn-generate" class="bg-indigo-600 hover:bg-indigo-500 px-4 py-2 rounded-lg text-sm"><i class="fa-solid fa-wand-magic-sparkles mr-2"></i><span id="gen-text">开始生成</span></button>
                    <input id="file-input" type="file" accept="image/*" class="hidden" />
                    <button id="btn-upload" class="bg-slate-800 hover:bg-slate-700 px-4 py-2 rounded-lg text-sm">上传参考图</button>
                    <span id="upload-hint" class="text-xs text-slate-400"></span>
                </div>
            </div>

            <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
                <h2 class="text-base font-medium mb-3">队列与历史</h2>
                <div id="job-list" class="space-y-3 text-sm">
                    <div class="flex items-center justify-between bg-slate-950 border border-slate-800 rounded p-3">
                        <div class="flex items-center gap-3">
                            <i class="fa-solid fa-spinner animate-spin text-slate-400"></i>
                            <div>
                                <div>无人机模型（生成中…）</div>
                                <div class="text-xs text-slate-400">预计 2 分钟</div>
                            </div>
                        </div>
                        <button class="text-xs px-2 py-1 border border-slate-700 rounded">取消</button>
                    </div>
                    <div class="flex items-center justify-between bg-slate-950 border border-slate-800 rounded p-3">
                        <div class="flex items-center gap-3">
                            <i class="fa-solid fa-check text-emerald-400"></i>
                            <div>
                                <div>机械臂模型</div>
                                <div class="text-xs text-slate-400">4 分钟前完成</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button class="text-xs px-2 py-1 border border-slate-700 rounded">查看</button>
                            <button class="text-xs px-2 py-1 border border-slate-700 rounded">下载</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <aside class="space-y-4">
            <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
                <h3 class="text-sm font-medium mb-3">点数余额</h3>
                <div class="text-2xl font-semibold">1,240</div>
                <div class="text-xs text-slate-400 mt-1">预计可生成约 24 次</div>
                <a href="pricing.html" target="_parent" class="mt-3 inline-block text-xs px-3 py-1 border border-slate-700 rounded">去购买</a>
            </div>
            <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
                <h3 class="text-sm font-medium mb-3">参数预设</h3>
                <div class="space-y-2 text-sm">
                    <button class="w-full bg-slate-800 hover:bg-slate-700 px-3 py-2 rounded text-left">游戏道具（实时）</button>
                    <button class="w-full bg-slate-800 hover:bg-slate-700 px-3 py-2 rounded text-left">电影资产（高精）</button>
                    <button class="w-full bg-slate-800 hover:bg-slate-700 px-3 py-2 rounded text-left">原型草案（快速）</button>
                </div>
            </div>
        </aside>
    </div>
    <script>
      (function(){
        var fileInput = document.getElementById('file-input');
        var btnUpload = document.getElementById('btn-upload');
        var btnGenerate = document.getElementById('btn-generate');
        var genText = document.getElementById('gen-text');
        var uploadHint = document.getElementById('upload-hint');
        var jobList = document.getElementById('job-list');

        var uploadedImageUrl = '';

        function setUploading(state, text){
          btnUpload.disabled = state;
          btnUpload.classList.toggle('opacity-60', state);
          uploadHint.textContent = text || '';
        }

        function setGenerating(state, text){
          btnGenerate.disabled = state;
          btnGenerate.classList.toggle('opacity-60', state);
          genText.textContent = text || (state ? '生成中…' : '开始生成');
        }

        function appendPendingItem(title){
          var wrapper = document.createElement('div');
          wrapper.className = 'flex items-center justify-between bg-slate-950 border border-slate-800 rounded p-3';
          wrapper.innerHTML = '<div class="flex items-center gap-3">\
              <i class="fa-solid fa-spinner animate-spin text-slate-400"></i>\
              <div>\
                <div>'+ title.replace(/</g,'&lt;') +'（生成中…）</div>\
                <div class="text-xs text-slate-400">队列已提交</div>\
              </div>\
            </div>';
          jobList.prepend(wrapper);
        }

        btnUpload.addEventListener('click', function(){
          fileInput.click();
        });

        fileInput.addEventListener('change', function(){
          if(!fileInput.files || !fileInput.files[0]) return;
          var file = fileInput.files[0];
          var token = (window.API && API.getToken && API.getToken()) || '';
          if(!token){
            // 跳转到登录页面
            window.location.href = 'login.html';


            return;
          }
          var form = new FormData();
          form.append('image', file);
          setUploading(true, '上传中…');
          fetch('api/upload/image.php', {
            method: 'POST',
            headers: token ? { 'Authorization': 'Bearer ' + token } : {},
            body: form
          }).then(function(res){ return res.text().then(function(t){ return { ok: res.ok, json: (function(){ try{return JSON.parse(t);}catch(e){return null;} })() }; }); })
            .then(function(result){
              if(result.ok && result.json && result.json.data && result.json.data.url){
                uploadedImageUrl = result.json.data.url;
                setUploading(false, '已上传');
              } else {
                setUploading(false, (result.json && (result.json.message || result.json.msg)) || '上传失败');
              }
            })
            .catch(function(){ setUploading(false, '上传失败'); });
        });

        btnGenerate.addEventListener('click', function(){
          var positive = document.getElementById('input-positive').value.trim();
          var negative = document.getElementById('input-negative').value.trim();
          var topology = document.getElementById('select-topology').value;
          var texture = document.getElementById('select-texture').value;
          var resolution = document.getElementById('select-resolution').value;
          var retopo = document.getElementById('chk-retopo').checked;
          var bake = document.getElementById('chk-bake').checked;
          var decimate = document.getElementById('chk-decimate').checked;

          var token = (window.API && API.getToken && API.getToken()) || '';
          if(!token){
            // 跳转到登录页面
            window.location.href = 'login.html';
            return;
          }
          if(!uploadedImageUrl){ alert('请先上传参考图'); return; }
          if(!positive){ alert('请填写正向提示'); return; }

          var name = positive.split(/[，,。.!？?]/)[0].slice(0, 30) || 'AI 模型';
          var modelType = 'object';
          // 简单映射，可按需扩展
          if(/(人物|角色|人|女孩|男孩)/.test(positive)) modelType = 'character';
          if(/(场景|房间|室内|室外|景观)/.test(positive)) modelType = 'scene';

          var description = JSON.stringify({
            positive: positive,
            negative: negative,
            options: {
              topology: topology,
              texture: texture,
              resolution: resolution,
              retopology: retopo,
              normalBake: bake,
              decimate: decimate
            }
          });

          setGenerating(true, '生成中…');
          (window.API && API.postJson ? API.postJson('api/model/generate.php', {
            name: name,
            description: description,
            image_url: uploadedImageUrl,
            model_type: modelType
          }, true) : Promise.reject(new Error('API 不可用')))
          .then(function(res){
            if(res.ok && res.json && res.json.data){
              appendPendingItem(name);
              setGenerating(false);
              alert('任务提交成功');
            } else {
              setGenerating(false);
              alert((res.json && (res.json.message || res.json.msg)) || '提交失败');
            }
          })
          .catch(function(){ setGenerating(false); alert('提交失败'); });
        });
      })();
    </script>
</body>
</html>

