<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>模型详情 - AI 3D</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
	<script src="js/api.js"></script>
    <style>body{background:#0b0f1a}</style>
</head>
<body class="text-slate-200">
    <div class="max-w-7xl mx-auto p-4 grid lg:grid-cols-3 gap-6">
		<div class="lg:col-span-2 space-y-4">
			<div id="mv-wrap" class="relative w-full h-[460px] bg-slate-900 border border-slate-800 rounded-xl overflow-hidden">
				<div id="mv-loading" class="absolute inset-0 flex flex-col items-center justify-center gap-3 bg-slate-900">
					<div class="h-10 w-10 rounded-full border-2 border-slate-600 border-t-transparent animate-spin"></div>
					<div class="text-xs text-slate-400">模型加载中，请稍候… <span id="mv-progress">0%</span></div>
					<div class="w-40 h-1 bg-slate-800 rounded">
						<div id="mv-bar" class="h-1 bg-indigo-500 rounded" style="width:0%"></div>
					</div>
				</div>
				<model-viewer id="mv" src="" camera-controls auto-rotate disable-zoom reveal="auto" crossorigin="anonymous" style="--poster-color: transparent;" class="w-full h-full"></model-viewer>
				<button id="mv-full" class="absolute bottom-2 right-2 z-10 px-2 py-1 rounded bg-black/40 hover:bg-black/60 text-slate-200 text-xs border border-white/10" title="全屏预览">
					<i class="fa-solid fa-expand"></i>
				</button>
			</div>
			<div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
                <h2 class="text-base font-medium mb-3">描述</h2>
				<p id="md-desc" class="text-sm text-slate-400">加载中…</p>
            </div>
            <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
                <h2 class="text-base font-medium mb-3">预览截图</h2>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                    <img class="h-28 w-full object-cover rounded-lg border border-slate-800" src="https://images.unsplash.com/photo-1527443224154-c4f2a1cb7c14?q=80&w=800&auto=format&fit=crop" alt="shot1" />
                    <img class="h-28 w-full object-cover rounded-lg border border-slate-800" src="https://images.unsplash.com/photo-1531030874896-fdef6826f2f7?q=80&w=800&auto=format&fit=crop" alt="shot2" />
                    <img class="h-28 w-full object-cover rounded-lg border border-slate-800" src="https://images.unsplash.com/photo-1498050108023-c5249f4df085?q=80&w=800&auto=format&fit=crop" alt="shot3" />
                </div>
            </div>
        </div>
		<aside class="space-y-4">
            <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
				<div class="flex items-center gap-3">
					<img id="md-author-avatar" src="" class="w-10 h-10 rounded-full border border-slate-700 bg-slate-800" />
					<div>
						<div id="md-author-name" class="text-sm font-medium">作者</div>
						<div id="md-stats" class="text-xs text-slate-400"></div>
					</div>
				</div>
                <div class="mt-4 grid grid-cols-2 gap-2 text-sm">
					<a id="md-download" class="bg-indigo-600 hover:bg-indigo-500 px-3 py-2 rounded text-center" href="#" download>下载 GLB</a>
                    <button class="bg-slate-800 hover:bg-slate-700 px-3 py-2 rounded">收藏</button>
                </div>
            </div>
            <div class="bg-slate-900 border border-slate-800 rounded-xl p-4 text-sm">
                <div class="flex items-center justify-between py-2 border-b border-slate-800"><span>多边形</span><span class="text-slate-300">24,316</span></div>
                <div class="flex items-center justify-between py-2 border-b border-slate-800"><span>材质</span><span class="text-slate-300">PBR（金属度/粗糙度）</span></div>
                <div class="flex items-center justify-between py-2"><span>许可</span><span class="text-slate-300">可商用</span></div>
            </div>
            <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
                <h3 class="text-sm font-medium mb-3">相关推荐</h3>
                <div class="space-y-3">
                    <a class="flex items-center gap-3" href="model-detail.html" target="_parent">
                        <img src="https://images.unsplash.com/photo-1593784991095-a205069470b6?q=80&w=400&auto=format&fit=crop" class="w-16 h-12 object-cover rounded border border-slate-800" />
                        <div class="text-sm">未来载具</div>
                    </a>
                    <a class="flex items-center gap-3" href="model-detail.html" target="_parent">
                        <img src="https://images.unsplash.com/photo-1579165466741-7f35e4755662?q=80&w=400&auto=format&fit=crop" class="w-16 h-12 object-cover rounded border border-slate-800" />
                        <div class="text-sm">机械手臂</div>
                    </a>
                </div>
            </div>
        </aside>
    </div>
<script>
(function(){
	var mv = document.getElementById('mv')
	var mvWrap = document.getElementById('mv-wrap')
	var btnFull = document.getElementById('mv-full')
	var box = document.getElementById('mv-loading')
	var txt = document.getElementById('mv-progress')
	var bar = document.getElementById('mv-bar')
	var elDesc = document.getElementById('md-desc')
	var elAuthor = document.getElementById('md-author-name')
	var elAuthorAvatar = document.getElementById('md-author-avatar')
	var elStats = document.getElementById('md-stats')
	var elDownload = document.getElementById('md-download')

	function hideLoading(){
		if(box){ box.style.display = 'none' }
	}

	// 从URL获取id
	function getQuery(name){
		var m = location.search.match(new RegExp('(?:\\?|&)' + name + '=([^&]+)'))
		return m ? decodeURIComponent(m[1]) : ''
	}

	function fullUrl(rel){
		if(!rel) return ''
		if(/^https?:\/\//i.test(rel)){
			// 若已是绝对地址，转为走后端文件输出代理以带上正确的CORS
			var abs = rel
			var base = 'http://localhost:3344/'
			if(abs.indexOf(base) === 0){ abs = abs.substring(base.length) }
			return 'http://localhost:3344/api/upload/file.php?path=' + encodeURIComponent(abs.replace(/^\/+/, ''))
		}
		// 相对路径统一通过文件输出接口
		return 'http://localhost:3344/api/upload/file.php?path=' + encodeURIComponent(rel.replace(/^\/+/, ''))
	}

	// 加载详情
	var modelId = getQuery('id') || ''
	if(modelId){
		API.getJson('model/detail.php?id=' + encodeURIComponent(modelId), true).then(function(res){
			var ok = res && res.ok && res.json && (res.json.code === 200)
			if(!ok){ throw new Error((res && res.json && res.json.message) || '加载失败') }
			var data = res.json.data || {}
			// 渲染模型地址
			if(mv){ mv.src = fullUrl(data.model_file) || '' }
			// 描述
			if(elDesc){ elDesc.textContent = data.description || '暂无描述' }
			// 作者
			if(elAuthor){ elAuthor.textContent = data.username || '匿名' }
			if(elAuthorAvatar){ elAuthorAvatar.src = data.avatar ? fullUrl(data.avatar) : '' }
			// 统计（简单展示类型/下载数）
			if(elStats){ elStats.textContent = (data.model_type || '').toUpperCase() + (data.download_count ? (' · 下载 ' + data.download_count) : '') }
			// 下载
			if(elDownload){ elDownload.href = data.model_file ? fullUrl(data.model_file) : '#' }
		}).catch(function(err){
			if(elDesc){ elDesc.textContent = '加载失败：' + (err && err.message ? err.message : '未知错误') }
		})
	}

	function setProgress(p){
		var val = Math.max(0, Math.min(100, Math.floor(p)))
		if(txt){ txt.textContent = val + '%' }
		if(bar){ bar.style.width = val + '%' }
	}

	setProgress(0)
	if(mv){
		mv.addEventListener('progress', function(e){
			try{
				var total = e.totalBytes || e.total || 0
				var loaded = e.loadedBytes || e.loaded || 0
				if(total > 0){ setProgress(loaded/total*100) }
				else { setProgress(30) }
			}catch(err){ setProgress(30) }
		})
		mv.addEventListener('load', function(){
			setProgress(100)
			// 延迟两帧，确保内部首帧渲染完成后再隐藏，避免闪屏
			requestAnimationFrame(function(){
				requestAnimationFrame(function(){ hideLoading() })
			})
		})
		mv.addEventListener('error', function(){
			if(txt){ txt.textContent = '加载失败' }
		})
	}

	// 全屏切换
	function isFullscreen(){
		return !!(document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement)
	}
	function requestFs(el){
		if(!el) return
		if(el.requestFullscreen){ return el.requestFullscreen.call(el) }
		if(el.webkitRequestFullscreen){ return el.webkitRequestFullscreen.call(el) }
		if(el.msRequestFullscreen){ return el.msRequestFullscreen.call(el) }
	}
	function exitFs(){
		if(document.exitFullscreen){ return document.exitFullscreen.call(document) }
		if(document.webkitExitFullscreen){ return document.webkitExitFullscreen.call(document) }
		if(document.msExitFullscreen){ return document.msExitFullscreen.call(document) }
	}
	function updateIcon(){
		if(!btnFull) return
		btnFull.innerHTML = isFullscreen() ? '<i class="fa-solid fa-compress"></i>' : '<i class="fa-solid fa-expand"></i>'
	}
	if(btnFull){
		btnFull.addEventListener('click', function(){
			if(isFullscreen()) exitFs(); else requestFs(mvWrap || mv)
		})
		document.addEventListener('fullscreenchange', updateIcon)
		document.addEventListener('webkitfullscreenchange', updateIcon)
		document.addEventListener('msfullscreenchange', updateIcon)
		updateIcon()
	}
})();
</script>
</body>
</html>

