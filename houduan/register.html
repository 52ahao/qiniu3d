<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>注册 - 七牛三弟</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <style>body{background:#0b0f1a}</style>
    <script src="js/api.js"></script>
</head>
<body class="text-slate-200">
    <div class="min-h-[80vh] flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-slate-900 border border-slate-800 rounded-2xl p-6">
            <div class="flex items-center gap-3 mb-6">
                <i class="fa-solid fa-cube text-indigo-400"></i>
                <div class="text-lg font-medium">创建你的账户</div>
            </div>
            <div class="space-y-3 text-sm">
                <div id="msg" class="hidden text-xs p-2 rounded border"></div>
                <div>
                    <label class="text-xs text-slate-400">用户名</label>
                    <input id="username" type="text" class="w-full bg-slate-950 border border-slate-800 rounded-lg p-3 mt-1" placeholder="昵称" />
                </div>
                <div>
                    <label class="text-xs text-slate-400">邮箱</label>
                    <input id="email" type="email" class="w-full bg-slate-950 border border-slate-800 rounded-lg p-3 mt-1" placeholder="you@example.com" />
                </div>
                <div>
                    <label class="text-xs text-slate-400">密码</label>
                    <input id="password" type="password" class="w-full bg-slate-950 border border-slate-800 rounded-lg p-3 mt-1" placeholder="至少 8 位" />
                </div>
                <div>
                    <label class="text-xs text-slate-400">确认密码</label>
                    <input id="confirm" type="password" class="w-full bg-slate-950 border border-slate-800 rounded-lg p-3 mt-1" placeholder="再次输入密码" />
                </div>
                <button id="submitBtn" class="w-full bg-indigo-600 hover:bg-indigo-500 rounded-lg p-3">注册</button>
                <div class="text-xs text-center text-slate-400">已有账户？<a href="login.html" target="_parent" class="text-slate-200 underline">去登录</a></div>
            </div>
        </div>
    </div>
    <script>
    (function(){
        var nameInput = document.getElementById('username');
        var emailInput = document.getElementById('email');
        var pwdInput = document.getElementById('password');
        var confirmInput = document.getElementById('confirm');
        var msg = document.getElementById('msg');
        var btn = document.getElementById('submitBtn');

        function setMsg(text, type){
            msg.textContent = text || '';
            if(!text){
                msg.classList.add('hidden');
                return;
            }
            msg.classList.remove('hidden');
            var success = type === 'success';
            msg.className = 'text-xs p-2 rounded border ' + (success ? 'text-emerald-300 bg-emerald-900/30 border-emerald-700' : 'text-rose-300 bg-rose-900/30 border-rose-700');
        }

        function disable(el, d){
            el.disabled = !!d;
            el.classList.toggle('opacity-60', !!d);
        }

        btn.addEventListener('click', function(){
            setMsg('');
            var username = (nameInput.value || '').trim();
            var email = (emailInput.value || '').trim();
            var password = (pwdInput.value || '').trim();
            var confirm = (confirmInput.value || '').trim();

            if(!username){ setMsg('请输入用户名', 'error'); return; }
            if(!email){ setMsg('请输入邮箱', 'error'); return; }
            if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ setMsg('邮箱格式不正确', 'error'); return; }
            if(!password){ setMsg('请输入密码', 'error'); return; }
            if(password.length < 6){ setMsg('密码长度至少6位', 'error'); return; }
            if(password !== confirm){ setMsg('两次输入的密码不一致', 'error'); return; }

            disable(btn, true);
            btn.textContent = '注册中...';

            API.postJson('auth/register.php', { username: username, email: email, password: password })
            .then(function(r){ return r.json; })
            .then(function(res){
                if(res && res.code === 200 && res.data){
                    // 注册成功后直接登录：保存token并跳转
                    try { window.localStorage.setItem('token', res.data.token); } catch(e){}
                    try { window.sessionStorage.setItem('token', res.data.token); } catch(e){}
                    try { window.localStorage.setItem('user', JSON.stringify(res.data.user || {})); } catch(e){}
                    try { window.sessionStorage.setItem('user', JSON.stringify(res.data.user || {})); } catch(e){}
                    setMsg('注册成功，正在跳转到首页...', 'success');
                    setTimeout(function(){ window.location.href = 'home.html'; }, 600);
                } else {
                    setMsg((res && res.message) || '注册失败', 'error');
                }
            }).catch(function(err){
                setMsg('网络错误：' + (err && err.message ? err.message : '请稍后重试'), 'error');
            }).finally(function(){
                disable(btn, false);
                btn.textContent = '注册';
            });
        });
    })();
    </script>
</body>
</html>

